<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T.R.R.A.M. Advisor Bot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // Enable dark mode based on 'dark' class
            theme: {
                extend: {
                    fontFamily: {
                        mono: ['"Courier New"', 'monospace'],
                    },
                    colors: {
                        'crt-green': '#00ff00',
                        'crt-dark': '#001a00',
                        'crt-yellow': '#ffcc00',
                        'crt-red': '#ff0000',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Courier New', monospace; }
        .crt {
            /* Basic CRT scanline effect */
            background: repeating-linear-gradient(
                to bottom,
                transparent 0,
                transparent 1px,
                rgba(0, 0, 0, 0.1) 1px,
                rgba(0, 0, 0, 0.2) 2px
            );
            /* Subtle flicker/blur effect for the text */
            text-shadow: 
                0 0 1px currentColor, 
                0 0 2px currentColor;
        }
        .crt.dark {
            background-color: #001a00; /* crt-dark */
        }
        .crt.light {
            background-color: #f0f0f0; /* Off-white for light mode contrast */
        }
        /* Custom scrollbar to match terminal aesthetic */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background-color: #00ff00; border-radius: 4px; }
        ::-webkit-scrollbar-track { background-color: transparent; }
    </style>
</head>
<body class="min-h-screen p-4 transition-colors duration-500" id="body-wrapper">
    <script type="module">
        // Import necessary Firebase and Gemini modules (using dynamic imports to prevent execution until loaded)
        window.firebaseModules = {
            firestore: await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js'),
            auth: await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js'),
            app: await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js')
        };
        window.geminiModules = {
            ai: await import('https://cdn.jsdelivr.net/npm/@google/genai@0.1.0/dist/gemini-2.1.0.js')
        };
        document.dispatchEvent(new Event('sdkLoadComplete'));
    </script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        const { getAuth, signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, setPersistence, browserSessionPersistence } = firebaseModules.auth;
        const { initializeApp } = firebaseModules.app;
        const { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, deleteDoc } = firebaseModules.firestore;
        const { GoogleGenerativeAI } = geminiModules.ai;

        // ====================================================================
        // 1. CONFIGURATION & MOCK DATA
        // ====================================================================

        // NOTE: REPLACE THESE WITH YOUR ACTUAL CONFIGURATION. 
        // DO NOT EXPOSE YOUR GEMINI_API_KEY DIRECTLY IN PRODUCTION CLIENT-SIDE CODE!
        // The current implementation is ONLY for a single-file demo.
        const firebaseConfig = {
            apiKey: "AIzaSyDlzdaDxUx21cTSKEkN1C5v_W6giZOKFDo",
            authDomain: "trram-1e002.firebaseapp.com",
            projectId: "trram-1e002",
            storageBucket: "trram-1e002.firebasestorage.app",
            messagingSenderId: "986737691566",
            appId: "1:986737691566:web:b7e83b547417236393d63f",
            measurementId: "G-KNSLC2X4NS"
        };
        
        // **SECURITY WARNING**: Using an API key directly in the client is INSECURE.
        // In a real application, this should be handled by a secure backend 
        // (like a Firebase Cloud Function) that proxies the request.
        const GEMINI_API_KEY = "AIzaSyDjz6jIPuQ--hk1XGy4bHFLNK7kc_7whI0"; 

        const INITIAL_PROMPT = `You are T.R.R.A.M. (Terminal-Retro-Robot-Academic-Manager), a snarky, yet highly intelligent, academic advisor bot. Your task is to generate a detailed 4-year course plan for a student based on a specified major and any custom requirements (e.g., specific courses, credit constraints).
        
        **Instructions for output:**
        1. **Do not include any conversational text, preamble, or markdown formatting outside of the JSON block.** The entire response must be a single, valid JSON object that adheres strictly to the CoursePlan interface provided below.
        2. **Generate exactly 8 semesters (Fall/Spring pairs) and exactly 4 Summer terms.**
        3. **Each course must have a unique, realistic four-letter department code (e.g., CS, MATH, ENGL, PHIL) and a three-digit number (e.g., 101, 345, 499).**
        4. **All credits must be integers (1-5).**
        5. **The total number of credits must be between 120 and 130.**
        
        **CoursePlan Interface:**
        interface Course {
            id: string; // Unique ID (e.g., "CS101-FALL1")
            code: string; // Course code (e.g., "CS 101")
            name: string; // Course name (e.g., "Intro to Programming")
            credits: number; // Credit hours (e.g., 3)
            isComplete: boolean; // Must always be false for a new plan
        }
        
        interface Semester {
            id: string; // Unique ID (e.g., "FALL1")
            name: string; // Semester name (e.g., "Fall Year 1")
            isSummer: boolean; // True if a summer session, false otherwise
            courses: Course[]; // List of courses
        }
        
        interface CoursePlan {
            major: string; // The user-specified major
            description: string; // A brief, snarky summary of the plan you generated.
            semesters: Semester[];
        }
        
        **User Request:** Generate a course plan for a major in [USER_MAJOR_INPUT] with the following special notes: [USER_NOTES_INPUT].
        
        Start the JSON response immediately.`;
        
        // ====================================================================
        // 2. REUSABLE COMPONENTS
        // ====================================================================

        // Icon Components (using simple SVG for retro style)
        const UserIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="feather feather-user"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        );
        const BotIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="feather feather-cpu"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"/><rect x="9" y="9" width="6" height="6"/><path d="M15 2v2M15 20v2M2 15h2M20 15h2M2 9h2M20 9h2M9 2v2M9 20v2"/></svg>
        );
        const SendIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        );
        const LogInIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="feather feather-log-in"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
        );
        const LogOutIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="feather feather-log-out"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        );
        const CheckIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="feather feather-check"><polyline points="20 6 9 17 4 12"/></svg>
        );
        const SunIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        );
        const MoonIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
        );
        const SaveIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="feather feather-save"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        );

        // Custom Hook for Dark Mode
        const useDarkMode = () => {
            const [isDarkMode, setIsDarkMode] = useState(() => {
                // Initialize from localStorage or default to true
                if (typeof window !== 'undefined') {
                    const savedMode = localStorage.getItem('isDarkMode');
                    return savedMode !== null ? JSON.parse(savedMode) : true;
                }
                return true;
            });

            useEffect(() => {
                const body = document.getElementById('body-wrapper');
                if (body) {
                    body.classList.add('crt');
                    body.classList.remove('crt-dark', 'crt-green-text', 'bg-crt-dark', 'text-crt-green');
                    body.classList.remove('crt-light', 'text-gray-900', 'bg-gray-100');

                    if (isDarkMode) {
                        body.classList.add('dark', 'bg-crt-dark', 'text-crt-green');
                    } else {
                        body.classList.remove('dark');
                        body.classList.add('bg-gray-100', 'text-gray-900');
                    }
                    localStorage.setItem('isDarkMode', JSON.stringify(isDarkMode));
                }
            }, [isDarkMode]);

            const terminalAccent = isDarkMode ? 'text-crt-green' : 'text-gray-900';

            return { isDarkMode, setIsDarkMode, terminalAccent };
        };

        // Terminal Wrapper Component
        const TerminalWrapper = ({ children, headerContent, isDarkMode, setIsDarkMode, terminalAccent, handleSignOut, userIsAnonymous }) => {
            return (
                <div className={`mx-auto max-w-6xl p-6 border-2 shadow-xl min-h-[90vh] flex flex-col transition-all duration-500 
                    ${isDarkMode 
                        ? 'bg-crt-dark border-crt-green shadow-crt-green/50' 
                        : 'bg-white border-gray-900 shadow-gray-400/50'
                    }`}
                >
                    {/* Header */}
                    <div className={`flex justify-between items-start pb-4 border-b-2 ${isDarkMode ? 'border-crt-green' : 'border-gray-900'}`}>
                        <div className="flex flex-col">
                            <h1 className={`text-xl font-bold uppercase ${terminalAccent}`}>T.R.R.A.M. ADVISOR v3.2</h1>
                            <p className={`text-xs uppercase ${isDarkMode ? 'text-crt-green' : 'text-gray-600'}`}>System Online. Awaiting Input.</p>
                        </div>
                        <div className="flex items-center space-x-4">
                            {headerContent}
                            
                            {/* Logout/Login Button */}
                            {userIsAnonymous === false && handleSignOut && (
                                <button
                                    onClick={handleSignOut}
                                    className={`flex items-center text-xs px-2 py-1 uppercase rounded-sm transition-colors duration-200 
                                        ${isDarkMode 
                                            ? 'text-crt-red hover:text-white hover:bg-crt-red border border-crt-red' 
                                            : 'text-red-600 hover:text-white hover:bg-red-600 border border-red-600'
                                        }`}
                                >
                                    <LogOutIcon className="w-4 h-4 mr-1" />
                                    LOGOUT
                                </button>
                            )}

                            {/* Dark Mode Toggle */}
                            <button
                                onClick={() => setIsDarkMode(!isDarkMode)}
                                className={`${terminalAccent} hover:opacity-75`}
                                title="Toggle Theme"
                            >
                                {isDarkMode ? <SunIcon className="w-6 h-6" /> : <MoonIcon className="w-6 h-6" />}
                            </button>
                        </div>
                    </div>
                    {/* Main Content */}
                    <div className="flex-grow pt-4 overflow-y-auto">
                        {children}
                    </div>
                </div>
            );
        };

        const ErrorMessage = ({ message, isDarkMode }) => (
            <div className={`p-4 my-4 rounded-none border-2 font-bold uppercase ${isDarkMode ? 'border-crt-red text-crt-red' : 'border-red-600 text-red-600'}`}>
                <p>ERROR: {message}</p>
                <p className="text-xs mt-1">REBOOT REQUIRED.</p>
            </div>
        );

        const LoadingIndicator = ({ isDarkMode }) => (
            <div className={`w-full text-center p-12 mt-10 ${isDarkMode ? 'text-crt-green' : 'text-gray-900'}`}>
                <BotIcon className={`w-10 h-10 mx-auto mb-4 animate-spin ${isDarkMode ? 'text-crt-green' : 'text-gray-900'}`} />
                <p className="text-lg uppercase">PROCESSING COMMAND...</p>
                <p className="text-sm mt-2 italic">STAND BY. T.R.R.A.M. IS NOT KNOWN FOR SPEED. IT IS KNOWN FOR ACCURACY.</p>
            </div>
        );

        // ====================================================================
        // 3. LOGIN SCREEN
        // ====================================================================

        const LoginScreen = ({ auth, onLoginSuccess, setError, isDarkMode, terminalAccent }) => {
            const [isRegister, setIsRegister] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError(null);

                try {
                    let userCredential;
                    if (isRegister) {
                        userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    } else {
                        userCredential = await signInWithEmailAndPassword(auth, email, password);
                    }
                    console.log("Authentication successful:", userCredential.user.uid);
                    onLoginSuccess();
                } catch (e) {
                    console.error("Authentication Error:", e.message);
                    let displayMessage = "Authentication failed. Check credentials or network.";
                    if (e.code === 'auth/email-already-in-use') {
                        displayMessage = "Email already in use. Try logging in or use a different email.";
                    } else if (e.code === 'auth/invalid-credential' || e.code === 'auth/wrong-password') {
                        displayMessage = "Invalid credentials. Try again.";
                    } else if (e.code === 'auth/weak-password') {
                        displayMessage = "Password is too weak. Must be at least 6 characters.";
                    }
                    setError(displayMessage);
                } finally {
                    setLoading(false);
                }
            };

            const handleAnonymousSignIn = async () => {
                setLoading(true);
                setError(null);
                try {
                    // This attempt will trigger the onAuthStateChanged in App, which handles the transition
                    await signInAnonymously(auth); 
                } catch (e) {
                    console.error("Anonymous Sign-In Failed:", e.message);
                    setError("Failed to initialize anonymous session. Please try again or create an account.");
                } finally {
                    setLoading(false);
                }
            }

            return (
                <div className="max-w-md mx-auto mt-24">
                    <div className={`p-8 border-2 ${isDarkMode ? 'border-crt-green bg-crt-dark' : 'border-gray-900 bg-white'}`}>
                        <h2 className={`text-2xl font-bold mb-6 text-center uppercase ${terminalAccent}`}>
                            {isRegister ? 'REGISTER NEW USER' : 'SYSTEM LOGIN'}
                        </h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className={`block text-sm font-bold uppercase mb-1 ${terminalAccent}`}>EMAIL:</label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className={`w-full p-2 border-2 text-sm font-mono ${isDarkMode 
                                        ? 'bg-black border-crt-green text-crt-green focus:ring-0' 
                                        : 'bg-white border-gray-900 text-gray-900 focus:ring-0'
                                    }`}
                                    required
                                    disabled={loading}
                                />
                            </div>
                            <div>
                                <label className={`block text-sm font-bold uppercase mb-1 ${terminalAccent}`}>PASSWORD:</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className={`w-full p-2 border-2 text-sm font-mono ${isDarkMode 
                                        ? 'bg-black border-crt-green text-crt-green focus:ring-0' 
                                        : 'bg-white border-gray-900 text-gray-900 focus:ring-0'
                                    }`}
                                    required
                                    disabled={loading}
                                />
                            </div>
                            <button
                                type="submit"
                                className={`w-full py-2 font-bold uppercase border-2 mt-4 transition-colors duration-200 ${loading ? 'opacity-50 cursor-not-allowed' : ''}
                                    ${isDarkMode 
                                        ? 'bg-crt-green text-crt-dark hover:bg-white hover:text-crt-dark' 
                                        : 'bg-gray-900 text-white hover:bg-gray-600'
                                    }`}
                                disabled={loading}
                            >
                                {loading ? 'ACCESSING...' : isRegister ? 'REGISTER' : 'LOGIN'}
                            </button>
                        </form>
                        
                        <div className={`text-center mt-4 text-xs ${terminalAccent}`}>
                            <button 
                                onClick={() => setIsRegister(!isRegister)} 
                                className="underline hover:text-crt-yellow"
                                disabled={loading}
                            >
                                {isRegister ? 'Already have an account? Login.' : 'Need an account? Register.'}
                            </button>
                        </div>
                        
                        <div className={`text-center my-4 ${isDarkMode ? 'text-crt-green' : 'text-gray-600'}`}>
                            — OR —
                        </div>

                        <button
                            onClick={handleAnonymousSignIn}
                            className={`w-full py-2 font-bold uppercase border-2 text-sm transition-colors duration-200 ${loading ? 'opacity-50 cursor-not-allowed' : ''}
                                ${isDarkMode 
                                    ? 'border-crt-green text-crt-green hover:bg-crt-green hover:text-crt-dark' 
                                    : 'border-gray-900 text-gray-900 hover:bg-gray-900 hover:text-white'
                                }`}
                            disabled={loading}
                        >
                            Skip for Anonymous Access
                        </button>
                        <p className={`text-center mt-2 text-xs ${isDarkMode ? 'text-crt-yellow' : 'text-red-500'}`}>
                            (WARNING: Anonymous access prevents plan saving.)
                        </p>
                    </div>
                </div>
            );
        };

        // ====================================================================
        // 4. MAIN APP LOGIC AND COMPONENTS
        // ====================================================================

        const App = () => {
            const { isDarkMode, setIsDarkMode, terminalAccent } = useDarkMode();
            
            // Firebase State
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [userIsAnonymous, setUserIsAnonymous] = useState(false);
            const [authReady, setAuthReady] = useState(false); // New flag for initial check completion
            
            // App State
            const [view, setView] = useState('loading'); // 'loading', 'login', 'planner'
            const [plan, setPlan] = useState(null); // The CoursePlan object from Gemini/Firestore
            const [majorInput, setMajorInput] = useState('');
            const [notesInput, setNotesInput] = useState('');
            const [loading, setLoading] = useState(false); // For Gemini API calls
            const [error, setError] = useState(null); // For general errors

            const initialAuthToken = null; // Can be used for custom auth flow

            // --- Gemini API Handler ---
            const generatePlan = useCallback(async () => {
                if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY") {
                    setError("GEMINI API Key not configured. Please check source code.");
                    return;
                }
                if (!majorInput) {
                    setError("Major field cannot be empty. T.R.R.A.M. requires data.");
                    return;
                }
                
                setLoading(true);
                setError(null);
                setPlan(null); // Clear previous plan

                try {
                    const finalPrompt = INITIAL_PROMPT
                        .replace('[USER_MAJOR_INPUT]', majorInput)
                        .replace('[USER_NOTES_INPUT]', notesInput || 'None.');

                    const ai = new GoogleGenerativeAI(GEMINI_API_KEY);
                    const model = ai.getGenerativeModel({ 
                        model: "gemini-2.5-flash",
                        config: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "object",
                                properties: {
                                    major: { type: "string" },
                                    description: { type: "string" },
                                    semesters: {
                                        type: "array",
                                        items: {
                                            type: "object",
                                            properties: {
                                                id: { type: "string" },
                                                name: { type: "string" },
                                                isSummer: { type: "boolean" },
                                                courses: {
                                                    type: "array",
                                                    items: {
                                                        type: "object",
                                                        properties: {
                                                            id: { type: "string" },
                                                            code: { type: "string" },
                                                            name: { type: "string" },
                                                            credits: { type: "number" },
                                                            isComplete: { type: "boolean" },
                                                        },
                                                        required: ["id", "code", "name", "credits", "isComplete"],
                                                    },
                                                },
                                            },
                                            required: ["id", "name", "isSummer", "courses"],
                                        },
                                    },
                                },
                                required: ["major", "description", "semesters"],
                            }
                        }
                    });

                    const result = await model.generateContent(finalPrompt);
                    const jsonText = result.text.trim().replace(/^```json\s*|```\s*$/g, '');
                    const newPlan = JSON.parse(jsonText);
                    
                    if (newPlan && newPlan.semesters && newPlan.semesters.length > 0) {
                        setPlan(newPlan);
                        // Attempt to auto-save after successful generation (only for logged-in users)
                        if (userId && !userIsAnonymous) {
                            await savePlan(newPlan);
                        }
                    } else {
                        throw new Error("T.R.R.A.M. returned an invalid or empty plan structure.");
                    }
                    
                } catch (e) {
                    console.error("Gemini API Error:", e);
                    setError(`GENERATION FAILED: ${e.message}. T.R.R.A.M. IS DISPLEASED.`);
                } finally {
                    setLoading(false);
                }
            }, [majorInput, notesInput, userId, userIsAnonymous]);

            // --- Firestore Handlers ---
            const planRef = useCallback(() => {
                if (db && userId) {
                    return doc(db, 'plans', userId);
                }
                return null;
            }, [db, userId]);

            const savePlan = useCallback(async (currentPlan) => {
                const ref = planRef();
                if (!ref || userIsAnonymous) {
                    console.log("Save skipped: User is anonymous or DB not ready.");
                    return;
                }
                try {
                    await setDoc(ref, currentPlan, { merge: false });
                    console.log("Plan saved successfully for user:", userId);
                    // No need to setPlan here as the state is already the latest.
                } catch (e) {
                    console.error("Firestore Save Error:", e);
                    setError("CRITICAL SAVE ERROR. Could not save plan to user profile.");
                }
            }, [planRef, userId, userIsAnonymous]);

            const loadPlan = useCallback(async () => {
                const ref = planRef();
                if (!ref) return;

                try {
                    const docSnap = await getDoc(ref);
                    if (docSnap.exists()) {
                        setPlan(docSnap.data());
                        setMajorInput(docSnap.data().major || '');
                        console.log("Plan loaded successfully.");
                    } else {
                        console.log("No existing plan found for user. Starting fresh.");
                    }
                } catch (e) {
                    console.error("Firestore Load Error:", e);
                    setError("CRITICAL LOAD ERROR. Could not retrieve plan.");
                }
            }, [planRef]);

            // --- State Mutators ---
            const toggleCourseCompletion = useCallback((semesterId, courseId, semester) => {
                setPlan(currentPlan => {
                    if (!currentPlan) return currentPlan;

                    const newPlan = JSON.parse(JSON.stringify(currentPlan));
                    
                    const targetSemester = newPlan.semesters.find(s => s.id === semesterId);
                    if (!targetSemester) return currentPlan;

                    const targetCourse = targetSemester.courses.find(c => c.id === courseId);
                    if (!targetCourse) return currentPlan;
                    
                    targetCourse.isComplete = !targetCourse.isComplete;
                    
                    // Auto-save the updated plan (only for logged-in users)
                    if (userId && !userIsAnonymous) {
                        savePlan(newPlan);
                    }
                    
                    return newPlan;
                });
            }, [userId, userIsAnonymous, savePlan]);
            
            // --- Authentication Handlers ---
            const handleSignOut = async () => {
                if (auth && signOut) {
                    try {
                        // CRITICAL: Set the view to 'login' *before* signing out
                        // This prevents the onAuthStateChanged listener from automatically trying
                        // to sign the user back in anonymously.
                        setView('login'); 
                        await signOut(auth);
                        setPlan(null);
                        setMajorInput('');
                        setNotesInput('');
                        // The onAuthStateChanged listener handles setting userId/userIsAnonymous to null/false
                    } catch (e) {
                        console.error("Sign Out Error:", e);
                        setError("Error: Failed to sign out.");
                    }
                }
            };

            // ====================================================================
            // 5. USE EFFECTS (CRITICAL FIREBASE LOGIC)
            // ====================================================================

            // 1. Firebase Initialization and Auth Listener
            useEffect(() => {
                // Wait for SDKs to be fully loaded
                const handleSDKLoad = () => {
                    // Only run once and if Firebase config is valid
                    if (authReady) return; 

                    try {
                        const app = initializeApp(firebaseConfig);
                        const authInstance = getAuth(app);
                        const dbInstance = getFirestore(app);
                        
                        setDb(dbInstance);
                        setAuth(authInstance);

                        // Set session persistence to maintain session across tabs/reloads
                        setPersistence(authInstance, browserSessionPersistence)
                            .then(() => {
                                console.log("Auth Persistence set to browserSessionPersistence.");
                            });

                        const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
                            setAuthReady(true); // Signal that the initial auth check is complete
                            setError(null); // Clear any old error once auth state is checked

                            if (user) {
                                // User is signed in (either persistent or anonymous)
                                setUserId(user.uid);
                                setUserIsAnonymous(user.isAnonymous);
                                setView('planner');
                                
                                if (!user.isAnonymous) {
                                    // Only load plan for non-anonymous users
                                    loadPlan();
                                }
                                console.log(`Auth State: Signed in. User ID: ${user.uid} (Anonymous: ${user.isAnonymous})`);
                            } else {
                                // User is logged out.
                                setUserId(null);
                                setUserIsAnonymous(false);
                                setPlan(null);
                                
                                // Check if we should attempt anonymous sign-in or force login view
                                if (view !== 'login') {
                                    // If we are starting fresh (not explicitly logged out)
                                    try {
                                        // 1. Try custom token sign-in (if provided, for more complex setups)
                                        if (initialAuthToken) {
                                            await signInWithCustomToken(authInstance, initialAuthToken);
                                            return; // onAuthStateChanged will re-run with the signed-in user
                                        }

                                        // 2. Final fallback: sign in anonymously for a default experience
                                        console.log("No user found. Attempting anonymous sign-in...");
                                        const userCredential = await signInAnonymously(authInstance);
                                        // The userCredential above triggers a new onAuthStateChanged call, 
                                        // which then executes the 'if (user)' block.
                                        
                                    } catch (anonErr) {
                                        console.error("Anonymous Sign-In Failed:", anonErr.message);
                                        // If everything fails (e.g., anonymous auth disabled), force login view
                                        setView('login'); 
                                    }
                                } else {
                                    // If 'view' is already 'login', keep it there (it was an explicit sign-out)
                                    setView('login');
                                }
                            }
                        });

                        return () => unsubscribe();
                    } catch (err) {
                        console.error("Firebase Init Error:", err);
                        setError("System Error: Could not initialize Firebase services. Check console for details.");
                        setAuthReady(true);
                        setView('login'); // Cannot initialize, so show login/error screen
                    }
                };

                // Listen for custom event that signals SDKs are loaded (from the <script type="module"> block)
                document.addEventListener('sdkLoadComplete', handleSDKLoad);

                return () => {
                    document.removeEventListener('sdkLoadComplete', handleSDKLoad);
                };
            }, [authReady, view, initialAuthToken, loadPlan]);

            // ====================================================================
            // 6. RENDER LOGIC
            // ====================================================================
            
            const totalCredits = useMemo(() => {
                if (!plan) return 0;
                return plan.semesters.reduce((sum, semester) => {
                    return sum + semester.courses.reduce((courseSum, course) => courseSum + course.credits, 0);
                }, 0);
            }, [plan]);

            const completedCredits = useMemo(() => {
                if (!plan) return 0;
                return plan.semesters.reduce((sum, semester) => {
                    return sum + semester.courses.filter(c => c.isComplete).reduce((courseSum, course) => courseSum + course.credits, 0);
                }, 0);
            }, [plan]);
            
            const completionPercentage = totalCredits > 0 ? Math.round((completedCredits / totalCredits) * 100) : 0;


            if (!authReady || view === 'loading') {
                return (
                    <TerminalWrapper isDarkMode={isDarkMode} setIsDarkMode={setIsDarkMode} terminalAccent={terminalAccent} userIsAnonymous={userIsAnonymous}>
                        <LoadingIndicator isDarkMode={isDarkMode} />
                    </TerminalWrapper>
                );
            }

            if (view === 'login') {
                return (
                    <TerminalWrapper isDarkMode={isDarkMode} setIsDarkMode={setIsDarkMode} terminalAccent={terminalAccent} userIsAnonymous={userIsAnonymous}>
                        {error && <ErrorMessage message={error} isDarkMode={isDarkMode} />}
                        <LoginScreen 
                            auth={auth} 
                            onLoginSuccess={() => setView('planner')} 
                            setError={setError}
                            isDarkMode={isDarkMode}
                            terminalAccent={terminalAccent}
                        />
                    </TerminalWrapper>
                );
            }
            
            // --- Planner View ---
            return (
                <TerminalWrapper 
                    isDarkMode={isDarkMode} 
                    setIsDarkMode={setIsDarkMode} 
                    terminalAccent={terminalAccent} 
                    handleSignOut={handleSignOut}
                    userIsAnonymous={userIsAnonymous}
                    headerContent={
                        plan ? (
                            <div className={`text-right text-xs uppercase ${terminalAccent}`}>
                                <p className="font-bold">PLAN: {plan.major}</p>
                                <p>Progress: {completedCredits}/{totalCredits} Credits ({completionPercentage}%)</p>
                            </div>
                        ) : null
                    }
                >
                    {error && <ErrorMessage message={error} isDarkMode={isDarkMode} />}
                    
                    {/* Input Area */}
                    <div className={`p-4 mb-6 border-2 flex flex-col space-y-4 
                        ${isDarkMode ? 'border-crt-green' : 'border-gray-900'}`}
                    >
                        <div className="flex space-x-4">
                            <div className="flex-1">
                                <label className={`block text-xs font-bold uppercase mb-1 ${terminalAccent}`}>Major/Program:</label>
                                <input
                                    type="text"
                                    value={majorInput}
                                    onChange={(e) => setMajorInput(e.target.value)}
                                    placeholder="e.g., 'B.S. in Computer Science'"
                                    className={`w-full p-2 text-sm font-mono border-2 ${isDarkMode 
                                        ? 'bg-black border-crt-green text-crt-green focus:ring-0' 
                                        : 'bg-white border-gray-900 text-gray-900 focus:ring-0'
                                    }`}
                                    disabled={loading}
                                />
                            </div>
                            <div className="flex-1">
                                <label className={`block text-xs font-bold uppercase mb-1 ${terminalAccent}`}>Special Notes (Optional):</label>
                                <input
                                    type="text"
                                    value={notesInput}
                                    onChange={(e) => setNotesInput(e.target.value)}
                                    placeholder="e.g., 'Need Calculus I and II transfer credit.'"
                                    className={`w-full p-2 text-sm font-mono border-2 ${isDarkMode 
                                        ? 'bg-black border-crt-green text-crt-green focus:ring-0' 
                                        : 'bg-white border-gray-900 text-gray-900 focus:ring-0'
                                    }`}
                                    disabled={loading}
                                />
                            </div>
                        </div>

                        <div className="flex space-x-4">
                            <button
                                onClick={generatePlan}
                                className={`flex items-center justify-center flex-1 py-3 font-bold uppercase border-2 transition-colors duration-200 
                                    ${loading ? 'opacity-50 cursor-not-allowed' : ''}
                                    ${isDarkMode 
                                        ? 'bg-crt-green text-crt-dark hover:bg-white hover:text-crt-dark' 
                                        : 'bg-gray-900 text-white hover:bg-gray-600'
                                    }`}
                                disabled={loading}
                            >
                                <SendIcon className="w-5 h-5 mr-2" />
                                {loading ? 'GENERATING...' : 'RUN PLAN GENERATION'}
                            </button>
                            
                            {/* Save Button (Only for non-anonymous users) */}
                            {userId && !userIsAnonymous && plan && (
                                <button
                                    onClick={() => savePlan(plan)}
                                    className={`flex items-center justify-center w-40 py-3 font-bold uppercase border-2 transition-colors duration-200 
                                        ${isDarkMode 
                                            ? 'border-crt-yellow text-crt-yellow hover:bg-crt-yellow hover:text-crt-dark' 
                                            : 'border-yellow-600 text-yellow-600 hover:bg-yellow-600 hover:text-white'
                                        }`}
                                    disabled={loading}
                                >
                                    <SaveIcon className="w-5 h-5 mr-2" />
                                    SAVE PLAN
                                </button>
                            )}
                        </div>
                    </div>
                    
                    {/* Anonymous User Warning */}
                    {userIsAnonymous && (
                        <div className={`p-2 mb-4 text-center border-2 ${isDarkMode ? 'border-crt-yellow text-crt-yellow' : 'border-yellow-600 text-yellow-600'}`}>
                            <p className="font-bold uppercase text-sm">WARNING: Anonymous Mode Active.</p>
                            <p className="text-xs">Your plan will not be saved. Please log in or register to enable saving.</p>
                        </div>
                    )}


                    {/* Plan Output */}
                    {loading && <LoadingIndicator isDarkMode={isDarkMode} />}

                    {plan && !loading ? (
                        <div className="space-y-6">
                            <div className={`p-4 border-2 ${isDarkMode ? 'border-crt-green text-crt-green' : 'border-gray-900 text-gray-900'}`}>
                                <h2 className="text-lg font-bold uppercase mb-2">T.R.R.A.M. Summary</h2>
                                <p className="italic">"{plan.description}"</p>
                                <div className={`mt-4 pt-2 border-t text-sm font-bold uppercase ${isDarkMode ? 'border-crt-green' : 'border-gray-400'}`}>
                                    Total Credits Planned: {totalCredits}
                                </div>
                            </div>
                            
                            {plan.semesters.map(semester => (
                                <div key={semester.id} className={`p-4 border-2 ${isDarkMode ? 'border-crt-green' : 'border-gray-900'} 
                                    ${semester.isSummer ? (isDarkMode ? 'bg-crt-dark/70' : 'bg-gray-200') : ''}`}>
                                    
                                    <h3 className={`text-xl font-bold uppercase mb-4 ${terminalAccent}`}>
                                        {semester.name}
                                        {semester.isSummer && <span className="text-xs ml-2">(Summer Session)</span>}
                                    </h3>
                                    
                                    {semester.courses.length === 0 ? (
                                        <p className="italic text-sm">Designated free session. Enjoy the break, mortal.</p>
                                    ) : (
                                        <>
                                            <ul className="space-y-2">
                                                {semester.courses.map(course => (
                                                    <li 
                                                        key={course.id} 
                                                        className={`flex justify-between items-center p-2 cursor-pointer border-l-4 transition-colors duration-150 
                                                            ${course.isComplete 
                                                                ? (isDarkMode ? 'border-crt-green line-through opacity-70' : 'border-green-600 line-through opacity-70')
                                                                : (isDarkMode ? 'border-crt-yellow hover:bg-crt-dark/50' : 'border-gray-900 hover:bg-gray-100')
                                                            }`}
                                                        onClick={() => toggleCourseCompletion(semester.id, course.id, semester)}
                                                    >
                                                        <div className="flex items-center">
                                                            {course.isComplete && <CheckIcon className={`w-4 h-4 mr-2 ${isDarkMode ? 'text-crt-green' : 'text-green-600'}`} />}
                                                            <span className="font-bold uppercase mr-4">{course.code}</span>
                                                            <span className="text-sm">{course.name}</span>
                                                        </div>
                                                        <span className={`text-sm font-mono ${isDarkMode ? 'text-crt-yellow' : 'text-gray-600'}`}>
                                                            {course.credits} Credits
                                                        </span>
                                                    </li>
                                                ))}
                                            </ul>
                                            <div className={`mt-4 pt-2 border-t text-sm font-bold uppercase ${isDarkMode ? 'border-crt-green text-crt-green' : 'border-gray-400 text-gray-600'}`}>
                                                Total: {semester.courses.reduce((sum, c) => sum + c.credits, 0)} Credits
                                            </div>
                                        </>
                                    )}
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div className={`w-full text-center p-12 border-2 border-dashed rounded-none mt-10 
                            ${isDarkMode ? 'border-crt-green text-crt-green' : 'border-gray-500 text-gray-600'}`
                        }>
                            <BotIcon className={`w-10 h-10 mx-auto mb-4 animate-pulse ${terminalAccent}`} />
                            <p className="text-lg uppercase">INITIALIZED. T.R.R.A.M. AWAITS COMMANDS.</p>
                            <p className="text-sm mt-2">Enter your program(s) above and click 'Run Plan' to start course generation.</p>
                            <p className="text-sm mt-4 italic">
                                Data will save automatically if you are logged in with an email/password account.
                            </p>
                        </div>
                    )}
                </TerminalWrapper>
            );
        };

        // Render the main component
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>